name: Deploy Cloudflare Pages
on:
  push:
    branches:
      - dev
      - master
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_PROJECT_NAME: ${{ secrets.CF_PAGES_PROJECT_NAME || 'amy-admin' }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup Node.js (required before pnpm)
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Debug: show environment & versions
        run: |
          echo "User: $(whoami)"
          echo "Node version:"
          node -v || true
          echo "npm version:"
          npm -v || true
          echo "pnpm path:"
          which pnpm || true
          echo "pnpm version:"
          pnpm -v || true
          echo "Working directory listing:"
          ls -la || true
          echo "Top of package.json (if exists):"
          if [ -f package.json ]; then head -n 50 package.json || true; else echo "no package.json in repo root"; fi

      - name: Determine branch
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            echo "BRANCH=${{ github.event.inputs.branch }}" >> $GITHUB_ENV
          else
            echo "BRANCH=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
          fi
          echo "Using branch: $BRANCH"

      - name: Install Dependencies
        # 如果你的项目在子目录（monorepo），把 working-directory 改成子目录路径
        run: |
          # 若遇到内存问题，可开启下面这一行
          # export NODE_OPTIONS="--max_old_space_size=4096"
          pnpm -v
          pnpm i --prefer-offline --no-frozen-lockfile
          pnpm build

      - name: Build & Deploy Pages (wrangler)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ env.CF_PROJECT_NAME }} --branch=${{ env.BRANCH }}
          packageManager: pnpm

      - name: Install jq & curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Get latest Pages deployment id
        id: get-deploy
        run: |
          api="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT_NAME}/deployments?order_by=created_on&direction=desc"
          echo "Calling $api" >&2
          resp=$(curl -s -H "Authorization: Bearer ${CF_API_TOKEN}" "$api")
          # 捕获可能的 API 错误信息
          api_errors=$(echo "$resp" | jq -c '.errors // empty')
          echo "api_errors=$api_errors" >> $GITHUB_OUTPUT

          # 按分支优先查找 deployment id
          deploy_id=$(echo "$resp" | jq -r --arg branch "$BRANCH" '.result[] | select(.deployment_trigger.revision.branch == $branch) | .id' | head -n 1)
          if [ -z "$deploy_id" ] || [ "$deploy_id" = "null" ]; then
            deploy_id=$(echo "$resp" | jq -r '.result[0].id')
          fi
          if [ -z "$deploy_id" ] || [ "$deploy_id" = "null" ]; then
            echo "No deployment found" >&2
            echo "deploy_id=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Found deploy id: $deploy_id" >&2
          echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT

      - name: Poll deployment status
        id: poll
        run: |
          deploy_id="${{ steps.get-deploy.outputs.deploy_id }}"
          if [ -z "$deploy_id" ]; then
            echo "status=not_found" >> $GITHUB_OUTPUT
            echo "deploy_url=" >> $GITHUB_OUTPUT
            echo "api_errors=${{ steps.get-deploy.outputs.api_errors }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          api_base="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT_NAME}/deployments"
          status=""
          deploy_url=""
          last_api_errors=""
          for i in $(seq 1 30); do
            resp=$(curl -s -H "Authorization: Bearer ${CF_API_TOKEN}" "${api_base}/${deploy_id}")
            status=$(echo "$resp" | jq -r '.result.status // "unknown"')
            deploy_url=$(echo "$resp" | jq -r '.result.url // ""')
            last_api_errors=$(echo "$resp" | jq -c '.errors // empty')
            echo "[$i] deployment ${deploy_id} status: $status"
            if [ "$status" = "ready" ] || [ "$status" = "failed" ]; then
              break
            fi
            sleep 10
          done
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "deploy_url=$deploy_url" >> $GITHUB_OUTPUT
          echo "api_errors=$last_api_errors" >> $GITHUB_OUTPUT

      - name: Send notification to Discord (and log response)
        if: always()
        run: |
          status="${{ steps.poll.outputs.status }}"
          deploy_url="${{ steps.poll.outputs.deploy_url }}"
          api_errors_get="${{ steps.get-deploy.outputs.api_errors }}"
          api_errors_poll="${{ steps.poll.outputs.api_errors }}"
          proj="${{ env.CF_PROJECT_NAME }}"
          branch="${{ env.BRANCH }}"

          if [ -z "$status" ] || [ "$status" = "not_found" ]; then
            content="⚠️ 无法获取 Cloudflare Pages 部署状态 — 项目：${proj} 分支：${branch}"
          elif [ "$status" = "ready" ]; then
            content="✅ 部署完成：${proj}（${branch}）\n访问：${deploy_url}"
          elif [ "$status" = "failed" ]; then
            content="❌ 部署失败：${proj}（${branch}）\n详情：${deploy_url}"
          else
            content="ℹ️ 部署状态：${status} — 项目：${proj} 分支：${branch} 链接：${deploy_url}"
          fi

          # 如果 Cloudflare API 返回 errors（例如 {"sender":["This field is required"]}），把它附加到消息
          combined_errors=""
          if [ -n "$api_errors_get" ] && [ "$api_errors_get" != "null" ]; then
            combined_errors="${combined_errors}GET_ERRORS: ${api_errors_get}\n"
          fi
          if [ -n "$api_errors_poll" ] && [ "$api_errors_poll" != "null" ]; then
            combined_errors="${combined_errors}POLL_ERRORS: ${api_errors_poll}\n"
          fi
          if [ -n "$combined_errors" ]; then
            content="${content}\n\nAPI_ERRORS:\n${combined_errors}"
          fi

          payload=$(jq -n --arg c "$content" '{content:$c, username:"CF Pages CI"}')

          # 发送并记录 HTTP 状态码与响应体，Discord 成功返回 204 (No Content)
          response=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" -X POST -d "$payload" "${DISCORD_WEBHOOK_URL}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          echo "Discord HTTP status: $http_code"
          if [ -n "$body" ]; then
            echo "Discord response body: $body"
          else
            echo "Discord response body: (empty)"
          fi

          if [ "$http_code" != "204" ]; then
            echo "Warning: Discord webhook returned non-204 status. Check webhook URL / payload."
            # 失败时把错误也写为步骤输出以便在 Actions UI 查阅
            echo "discord_status=${http_code}" >> $GITHUB_OUTPUT
            echo "discord_body=${body}" >> $GITHUB_OUTPUT
            exit 0
          fi

